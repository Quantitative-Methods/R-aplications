---
title: "Canonical Correlation Analysis"
output: 
  flexdashboard::flex_dashboard:
    #theme: bootstrap
    #theme: cerulean
    #theme: flatly
    #theme: united
    #theme: simplex
    theme: yeti
    logo: R_logo.png
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(tidyverse)
library(DT)
library(psych)
library(rstatix)
library(corrr)
library(tigerstats)
library(skimr)
library(yacca)
```

```{r Učitavanje podataka iz CSV datoteke}

#data <- read.table(file = "SKOLA.csv",               
data <- read.table(file.choose(),                  
                   header = TRUE,                      
                   dec = ",",                          
                   sep = ";",                          
                   stringsAsFactors = TRUE,
                   row.names = 1)

#saveRDS(data, file = "JUDO3F.RData") 
#head(data)
```

```{r Selekcija varijabli}


B1 <- data %>% select(TAPI, POLI, SDAL, POTR, PRRA, IZVI, TR6M)
B2 <- data %>% select(VISI, TEZI, OBPO, NABN)

```

```{r}
summary <- skim(data)
my_data <- data %>% select_if(is.numeric)
B <- cbind(B1, B2)
nvar1 <- colnames(B1)
nvar2 <- colnames(B2)
nvar <- colnames(B)
n <- nrow(data)                                  
m1 <- ncol(B1)
m2 <- ncol(B2)
m <- ncol(B)
if (m1<m2) {k=m1} else {k=m2}
```

```{r}
ds1 <- describe(B1, type=2)
ds1 <- ds1[c(3,5,4,8,9,10,11,12)]
colnames(ds1) <- c("Mean", "Median", "St.dev", "Min", "Max", "Range", "Skew", "Kurt")
ds1 <- round(ds1, digits = 2)
```

```{r}
ds2 <- describe(B2, type=2)
ds2 <- ds2[c(3,5,4,8,9,10,11,12)]
colnames(ds2) <- c("Mean", "Median", "St.dev", "Min", "Max", "Range", "Skew", "Kurt")
ds2 <- round(ds2, digits = 2)
```

```{r}
Z <- round(scale(my_data), digits = 2)
Z1 <- round(scale(B1), digits = 2)
Z2 <- round(scale(B2), digits = 2)
```

```{r}
R1 <- cor(B1)
R2 <- cor(B2)
RP <- corr.test(B)
R <- RP$r
P <- RP$p
```

```{r}
Rcnames <- c("Rc1", "Rc2","Rc3","Rc4","Rc5","Rc6","Rc7","Rc8","Rc9","Rc10","Rc11","Rc12","Rc13","Rc14","Rc15")
Rcn <- Rcnames[1:k]
rcca<- cca (B1, B2, xscale = TRUE, yscale = TRUE, standardize.scores = TRUE)
p <- pchisq(rcca$chisq, rcca$df,lower.tail = FALSE)
TRC <- cbind(round(rcca$corr, digits = 2), round(rcca$chisq, digits = 2), rcca$df, 
round(p,digits = 5))
colnames(TRC) <- c("Rc", "Chi-sq.","Df", "p-level")
TRC1 <- cbind.data.frame(Rcn,TRC)
```

```{r}
lamda1 <- eigen(R1)
lamda2 <- eigen(R2)
Eigenvalue1 <- lamda1$values
Eigenvalue2 <- lamda2$values
Eigenvectors1 <- lamda1$vectors
Eigenvectors2 <- lamda2$vectors
```

```{r}
K1 <- Z1 %*% Eigenvectors1
l1 <- sqrt(diag(Eigenvalue1,m1))                    
ZK1 <- K1 %*% solve(l1)                         

K2 <- Z2 %*% Eigenvectors2
l2 <- sqrt(diag(Eigenvalue2,m2))                    
ZK2 <- K2 %*% solve(l2) 
```

```{r}
if (m1>m2) {
   Q <- t(ZK1) %*% ZK2 /(n-1)
   QTQ <- t(Q) %*% Q
   RC2 <- eigen(QTQ)
   RC <- sqrt(RC2$values)
   Y2 <- RC2$vectors
   Y1 <- Q %*% Y2 %*% solve(diag(RC))
   CF1 <- ZK1 %*% Y1
   CF2 <- ZK2 %*% Y2
   F1 <- t(Z1) %*% CF1/ (n-1)
   F2 <- t(Z2) %*% CF2/ (n-1)
} else {
  Q <- t(ZK2) %*% ZK1 /(n-1)
  QTQ <- t(Q) %*% Q
  RC2 <- eigen(QTQ)
  RC <- sqrt(RC2$values)
  Y2 <- RC2$vectors
  Y1 <- Q %*% Y2 %*% solve(diag(RC))
  CF1 <- ZK1 %*% Y2
  CF2 <- ZK2 %*% Y1
  F1 <- (t(Z1) %*% CF1/ (n-1))
  F2 <- (t(Z2) %*% CF2/ (n-1))
} 

fnames <- c("CF1","CF2","CF3","CF4","CF5","CF6","CF7","CF8","CF9","CF10","CF11","CF12","CF13","CF14","CF15")

Faktori <- fnames[1:k]
colnames(CF1) <- fnames[1:k]
colnames(CF2) <- fnames[1:k]
colnames(F1) <- fnames[1:k]
colnames(F2) <- fnames[1:k]
```

```{r}
F1 <- round(F1, digits = 2)
F2 <- round(F2, digits = 2)
Fac1 <- rep(Faktori, each=m1)
Fac2 <- rep(Faktori, each=m2)
Var1 <- rep(nvar1, times=k)
Var2 <- rep(nvar2, times=k)
Loa1 <- c()
for (a in 1:k) {Loa1 <- c(Loa1,F1[,a])}
CFF1 <- data_frame(Fac1,Var1,Loa1)
Loa2 <- c()
for (a in 1:k) {Loa2 <- c(Loa2,F2[,a])}
CFF2 <- data_frame(Fac2,Var2,Loa2)
```

```{r}
GRCC <- ggplot(data=TRC1, aes(x=Rcn,y=Rc)) +
  geom_bar(stat="identity", color="#ffffff", fill="#007acc") +
  labs(x ="",y ="",title= "")+
  theme_minimal()

GCF1 <- ggplot(data=CFF1, aes(x=Fac1,y=Loa1,fill=Var1)) +
  geom_bar(position ="stack",stat="identity") +
  labs(x ="Kanonički faktori",y ="Loadings",fill ="Varijable",title= "")+
  theme_minimal()

GCF2 <- ggplot(data=CFF2, aes(x = Fac2,y=Loa2 ,fill=Var2)) +
  geom_bar(position ="stack",stat="identity") +
  labs(x ="Kanonički faktori",y ="Loadings",fill ="Varijable",title= "")+
  theme_minimal()
```

Data
=======================================================================

Column {data-width=10}
-----------------------------------------------------------------------

### Cases

```{r}
valueBox(n)
```

### Variables First Set

```{r}
valueBox(m1)
```

### Variables Second Set

```{r}
valueBox(m2)
```

### Data

```{r}
valueBox(n*(m1+m2))
```


Column {data-width=200}
-----------------------------------------------------------------------

### Method


Column {data-width=440 .tabset}
-----------------------------------------------------------------------

### Data

```{r}
DT::datatable(data, extensions = 'Buttons', options = list(pageLength = n, dom = 'Bfrtip',buttons = c('copy','csv', 'excel')))
```

### Data Summary

```{r}
summary
```

### Z - values

```{r}
DT::datatable(Z, extensions = 'Buttons', options = list(pageLength = n, dom = 'Bfrtip',buttons = c('copy','csv', 'excel')))
```

Column {data-width=350 .tabset}
-----------------------------------------------------------------------

### Canonical Factors - First Set

```{r}
DT::datatable(CF1, extensions = 'Buttons', options = list(pageLength = n, dom = 'Bfrtip',buttons = c('copy','csv', 'excel'))) %>% formatRound(colnames(CF1), digits=2)
```

### Canonical Factors - Second Set

```{r}
DT::datatable(CF2, extensions = 'Buttons', options = list(pageLength = n, dom = 'Bfrtip',buttons = c('copy','csv', 'excel'))) %>% formatRound(colnames(CF2), digits=2)
```

Descriptive Statistics
=======================================================================

Column {data-width=10}
-----------------------------------------------------------------------

### Cases

```{r}
valueBox(n)
```

### Variables First Set

```{r}
valueBox(m1)
```

### Variables Second Set

```{r}
valueBox(m2)
```

### Data

```{r}
valueBox(n*(m1+m2))
```

Column {data-width=390}
-----------------------------------------------------------------------

### Descriptive Statistics - First Set

```{r}
DT::datatable (ds1, extensions = 'Buttons', options = list(pageLength = m1, dom = 'Bt',buttons = c('copy')))
```

### Descriptive Statistics - First Set

```{r}
DT::datatable (ds2, extensions = 'Buttons', options = list(pageLength = m2, dom = 'Bt',buttons = c('copy')))
```

Column {data-width=600}
-----------------------------------------------------------------------

### Graph Analysis

```{r}
shinyApp(

ui <- fluidPage(
        sidebarPanel(
          radioButtons("radio", 
                       label = "Select Variable:",
                       choices = colnames(my_data)),
          
            sliderInput("bins",
                        "Broj razreda:",
                        min = 1,
                        max = 100,
                        value = 7)
        ),
        mainPanel(
          h4("Normality Test (Shapiro-Wilk)"),
          textOutput("shapiro"),
          hr(),
          h4("Histogram"),
          plotOutput("histogram"),
          hr(),
          h4("Box and Whiskers Plot"),
          plotOutput("box")
          )
),
server <- function(input, output, session) {

      selectedData <- reactive({
        my_data[, input$radio]
  })
     
      output$shapiro <- renderText({ 
        w <- selectedData()
        sw <- shapiro.test(w)
        W <- round(sw$statistic, digits = 3)
        p <- round(sw$p.value, digits = 3)
        paste("W = ", W,", p = ", p)
  })
      output$histogram <- renderPlot({
        x    <- selectedData()
        mean <- mean(selectedData())
        sd <- sd(selectedData())
        density <- dnorm(x=x, mean=mean(x), sd=sd(x)) 
        
        ggplot(my_data, aes(x=x)) + 
        geom_histogram(bins=input$bins, color="#ffffff", fill="#8ecae6") +
        geom_line(data=my_data, aes(y=density*n*(max(x)-min(x))/input$bins), colour="#e5e5e5", size=1) +
        labs(x= input$radio) +
        theme_minimal()
    })
      output$box <- renderPlot({
        Variables  <- selectedData()
        ggplot(my_data, aes(x=Variables, y=0)) + 
        geom_violin (fill='#8ecae6', color="#ffffff", alpha=0.7) +
        geom_boxplot(fill='#8ecae6', color="#ffffff",outlier.colour="red",outlier.shape=8, outlier.size=4) +
        labs(x = input$radio) +
        theme_minimal()
       })   
},
shinyApp(ui = ui, server = server)
)
```

Correlation Analysis
=======================================================================

Column {data-width=10}
-----------------------------------------------------------------------

### Cases

```{r}
valueBox(n)
```

### Variables First Set

```{r}
valueBox(m1)
```

### Variables Second Set

```{r}
valueBox(m2)
```

### Data

```{r}
valueBox(n*(m1+m2))
```

Column {data-width=495}
-----------------------------------------------------------------------

### Correlation Matrix

```{r}
DT::datatable (R, extensions = 'Buttons', options = list(pageLength = m, dom = 'Bt',buttons = c('copy'))) %>% formatRound(colnames(R), digits=4)
```

Column {data-width=495}
-----------------------------------------------------------------------

### p - value

```{r}
DT::datatable (P, extensions = 'Buttons', options = list(pageLength = m, dom = 'Bt',buttons = c('copy'))) %>% formatRound(colnames(P), digits=4) %>% formatStyle(nvar, color = styleInterval(c(0.05), c('red', 'black')))
```

Canonical Correlation Analysis
=======================================================================

Column {data-width=10}
-----------------------------------------------------------------------

### Cases

```{r}
valueBox(n)
```

### Variables First Set

```{r}
valueBox(m1)
```

### Variables Second Set

```{r}
valueBox(m2)
```

### Data

```{r}
valueBox(n*(m1+m2))
```


Column {data-width=270}
-----------------------------------------------------------------------

### Canonical Correlations

```{r}
DT::datatable (TRC, rownames=FALSE, extensions = 'Buttons', options = list(pageLength = k, dom = 'Bt',buttons = c('copy'))) %>% formatStyle("p-level", color = styleInterval(c(0.05), c('red', 'black')))
```

### Graph of Canonical Correlations

```{r}
GRCC
```

Column {data-width=365}
-----------------------------------------------------------------------

### Canonical Loadings First Set

```{r}
DT::datatable (F1, extensions = 'Buttons', options = list(pageLength = m1, dom = 'Bt',buttons = c('copy')))

```

### Graph of Canonical Loadings First Set

```{r}
GCF1
```


Column {data-width=365}
-----------------------------------------------------------------------

### Canonical Loadings Second Set

```{r}
DT::datatable (F2, extensions = 'Buttons', options = list(pageLength = m2, dom = 'Bt',buttons = c('copy')))
```

### Graph of Canonical Loadings Second Set

```{r}
GCF2
```

