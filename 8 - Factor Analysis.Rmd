---
title: "Faktorska analiza"
output: 
  flexdashboard::flex_dashboard:
    #theme: bootstrap
    #theme: cerulean
    #theme: flatly
    #theme: united
    #theme: simplex
    theme: yeti
    logo: R_logo.png
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(tidyverse)
library(DT)
library(psych)
library(rstatix)
library(corrr)
library(GPArotation)
library(skimr)
```

```{r Uƒçitavanje podataka iz CSV datoteke}

#data <- read.table(file = "JUDO3F.csv",               
data <- read.table(file.choose(),                  
                   header = TRUE,                      
                   dec = ",",                          
                   sep = ";",                          
                   stringsAsFactors = TRUE,
                   row.names = 1)

#saveRDS(data, file = "JUDO3F.RData") 
#head(data)
```

```{r Selekcija varijabli}

my_data <- data %>% select_if(is.numeric)
#my_data <- data[c(1,2,3,4,5,6,7,8,9)]                 
#my_data <- data %>% select(ONT, OUZ, NEB, SKL, TRB, CUC, SDM, BML, T20m)   
#my_data <- data %>% select(everything())
```

```{r}
varijable <- names(my_data)
n <- nrow(my_data)                                  
m <- ncol(my_data)
i <- rep(1,n)
j <- rep(1,m)
summary <- skim(data)
Z <- round(scale(my_data), digits = 2)
```

```{r}
ds <- describe(my_data, type=2)
ds <- ds[c(3,5,4,8,9,10,11,12)]
colnames(ds) <- c("Mean", "Median", "St.dev", "Min", "Max", "Range", "Skew", "Kurt")
ds <- round(ds, digits = 2)
```

```{r}
RP <- corr.test(my_data)
R <- RP$r
P <- RP$p
```

```{r}
eignR<- eigen(R)
Eigenvalue <- round(eignR$values, digits = 2)
Cum.Eign <- round(cumsum(Eigenvalue), digits = 2)
Percentage <- round(Eigenvalue/sum(Eigenvalue)*100, digits = 2)
Cum.Per <- round(cumsum(Percentage),digits = 2)
rbl <- as.character(seq(1,m, by=1))
Lamda1  <- cbind.data.frame(rbl, Eigenvalue, Cum.Eign, Percentage, Cum.Per)
Lamda <- cbind(Eigenvalue, Cum.Eign, Percentage, Cum.Per)
rownames(Lamda) <- 1:m
Eigen_vectors <- eignR$vectors
```

```{r}
spgk <- ggplot(data=Lamda1, aes(x=rbl, y=Eigenvalue, group=1)) +
  geom_line(color="#007acc", size=1.2)+
  geom_point(color="#007acc",size=3) +
  labs(x ="Eigenvalue number",y ="Eigenvalue",fill ="",title= "")+
  geom_hline(yintercept = 1, linetype = "dashed",  color="red")+
  theme_minimal()
```

```{r}
SMC <- 1-(1/diag(solve(R)))
SSMC<- SMC %*% j
ssmc <- SSMC[1,1]

sppb <- ggplot(data=Lamda1, aes(x=rbl, y=Cum.Eign, group=1)) +
  geom_line(color="#007acc", size=1.2)+
  geom_point(color="#007acc",size=3) +
  labs(x ="Eigenvalue number",y ="Cumulative Eigenvalue",fill ="",title= "")+
  geom_hline(yintercept = ssmc, linetype = "dashed",  color="red")+
  theme_minimal()
```

```{r}
lamda_values <- c(Eigenvalue[Eigenvalue>=1])
k <- length(lamda_values)
#k <- 3
lamda_vectors <- Eigen_vectors[,c(1:k)]
```

```{r}
knames <- c("K1","K2","K3","K4","K5","K6","K7","K8","K9","K10","K11","K12","K13","K14","K15","K16","K17","K18","K19","K20")
K <- Z %*% lamda_vectors
l <- sqrt(diag(lamda_values,k))                    
ZK <- K %*% solve(l)                         
colnames(ZK) <- knames[1:k]
FSgk <- round(ZK, digits = 2)
```

```{r}
f <- rep(1,k) 
H <- (t(Z) %*% ZK/(n-1))*-1
H2 <- H * H
KOM <- H2 %*% f
colnames (KOM) <- c("Comm")
HK <- cbind(H,KOM,SMC)
Hgk <- (round(HK, digits = 2))
```

```{r}
fnames <- c("F1", "F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F91","F20")
Faktori <- fnames[1:k]
varimax <- varimax (H, normalize=TRUE)
F_varimax <- H %*% varimax$rotmat
colnames(F_varimax) <- fnames[1:k]
Fvf <- round(F_varimax, digits = 2)
```

```{r}
BETA1 <- F_varimax %*% (solve((t(F_varimax) %*% F_varimax)))
FS1 <- Z %*% BETA1
FSvf <- round(FS1, digits = 2)
```

```{r}
oblimin <- oblimin(H, normalize=TRUE)
F_oblimin <- oblimin$loadings
colnames(F_oblimin) <- fnames[1:k]
Fof <- round(F_oblimin, digits = 2)
R_oblimin <- oblimin$Phi
colnames(R_oblimin) <- fnames[1:k]
rownames(R_oblimin) <- fnames[1:k]
Rof <- round(R_oblimin, digits = 2)
```

```{r}
BETA2 <- F_oblimin %*% (solve((t(F_oblimin) %*% F_oblimin)))
FS2 <- Z %*% BETA2
FSof <- round(FS2, digits = 2)
```

```{r}
F1 <- round(F_varimax*F_varimax, digits = 2)
F2 <- round(F_oblimin*F_oblimin, digits = 2)
Fac <- rep(Faktori, each=m)
Var <- rep(varijable, times=k)
F1 <- round(F_varimax*F_varimax, digits = 2)
Loa1 <- c()
for (a in 1:k) {Loa1 <- c(Loa1,F1[,a])}
FF1 <- data_frame(Fac,Var,Loa1)
Loa2 <- c()
for (a in 1:k) {Loa2 <- c(Loa2,F2[,a])}
FF2 <- data_frame(Fac,Var,Loa2)
```

```{r}
GFF11 <- ggplot(data=FF1, aes(x=Var,y=Loa1,fill=Fac)) +
  geom_bar(position ="stack",stat="identity") +
  labs(x ="Variables",y ="Loadings",fill ="Factors",title= "")+
  theme_minimal()

GFF12 <- ggplot(data=FF1, aes(x = Fac,y=Loa1 ,fill=Var)) +
  geom_bar(position ="stack",stat="identity") +
  labs(x ="Factors",y ="Loadings",fill ="Variables",title= "")+
  theme_minimal()
```

```{r}
GFF21 <- ggplot(data=FF2, aes(x=Var,y=Loa2,fill=Fac)) +
  geom_bar(position ="stack",stat="identity") +
  labs(x ="Variables",y ="Loadings",fill ="Factors",title= "")+
  theme_minimal()

GFF22 <- ggplot(data=FF2, aes(x = Fac,y=Loa2 ,fill=Var)) +
  geom_bar(position ="stack",stat="identity") +
  labs(x ="Factors",y ="Loadings",fill ="Variables",title= "")+
  theme_minimal()
```

Data
=======================================================================

Column {data-width=10}
-----------------------------------------------------------------------

### Cases

```{r}
valueBox(n)
```

### Variables

```{r}
valueBox(m)
```

### Data

```{r}
valueBox(n*m)
```

Column {data-width=200}
-----------------------------------------------------------------------

### Method


Column {data-width=440 .tabset}
-----------------------------------------------------------------------

### Data

```{r}
DT::datatable(data, extensions = 'Buttons', options = list(pageLength = n, dom = 'Bfrtip',buttons = c('copy','csv', 'excel')))
```

### Data Summary

```{r}
summary
```

### Z - values

```{r}
DT::datatable(Z, extensions = 'Buttons', options = list(pageLength = n, dom = 'Bfrtip',buttons = c('copy','csv', 'excel')))
```

## Column {data-width=350 .tabset}
-----------------------------------------------------------------------

### Glavne komponente

```{r}
DT::datatable(FSgk, extensions = 'Buttons', options = list(pageLength = n, dom = 'Bfrtip',buttons = c('copy','csv', 'excel')))
```

### Varimax faktori

```{r}
DT::datatable(FSvf, extensions = 'Buttons', options = list(pageLength = n, dom = 'Bfrtip',buttons = c('copy','csv', 'excel')))
```

### Oblimin faktori

```{r}
DT::datatable(FSof, extensions = 'Buttons', options = list(pageLength = n, dom = 'Bfrtip',buttons = c('copy','csv', 'excel')))
```


Descriptive Statistics
=======================================================================

Column {data-width=10}
-----------------------------------------------------------------------

### Cases

```{r}
valueBox(n)
```

### Variables

```{r}
valueBox(m)
```

### Data

```{r}
valueBox(n*m)
```

Column {data-width=390}
-----------------------------------------------------------------------

### Descriptive Statistics

```{r}
DT::datatable (ds, extensions = 'Buttons', options = list(pageLength = m, dom = 'Bt',buttons = c('copy')))
```

Column {data-width=600}
-----------------------------------------------------------------------

### Graph Analysis

```{r}
shinyApp(

ui <- fluidPage(
        sidebarPanel(
          radioButtons("radio", 
                       label = "Select Variable:",
                       choices = colnames(my_data)),
          
            sliderInput("bins",
                        "Broj razreda:",
                        min = 1,
                        max = 100,
                        value = 7)
        ),
        mainPanel(
          h4("Normality Test (Shapiro-Wilk)"),
          textOutput("shapiro"),
          hr(),
          h4("Histogram"),
          plotOutput("histogram"),
          hr(),
          h4("Box and Whiskers Plot"),
          plotOutput("box")
          )
),
server <- function(input, output, session) {

      selectedData <- reactive({
        my_data[, input$radio]
  })
     
      output$shapiro <- renderText({ 
        w <- selectedData()
        sw <- shapiro.test(w)
        W <- round(sw$statistic, digits = 3)
        p <- round(sw$p.value, digits = 3)
        paste("W = ", W,", p = ", p)
  })
      output$histogram <- renderPlot({
        x    <- selectedData()
        mean <- mean(selectedData())
        sd <- sd(selectedData())
        density <- dnorm(x=x, mean=mean(x), sd=sd(x)) 
        
        ggplot(my_data, aes(x=x)) + 
        geom_histogram(bins=input$bins, color="#ffffff", fill="#8ecae6") +
        geom_line(data=my_data, aes(y=density*n*(max(x)-min(x))/input$bins), colour="#e5e5e5", size=1) +
        labs(x= input$radio) +
        theme_minimal()
        
    })
      
       output$box <- renderPlot({
        Variables  <- selectedData()
        ggplot(my_data, aes(x=Variables, y=0)) + 
        geom_violin (fill='#8ecae6', color="#ffffff", alpha=0.7) +
        geom_boxplot(fill='#8ecae6', color="#ffffff",outlier.colour="red",outlier.shape=8, outlier.size=4) +
        labs(x = input$radio) +
        theme_minimal()
       })   
},
shinyApp(ui = ui, server = server)
)
```

Correlation Analysis
=======================================================================

Column {data-width=10}
-----------------------------------------------------------------------

### Cases

```{r}
valueBox(n)
```

### Variables

```{r}
valueBox(m)
```

### Data

```{r}
valueBox(n*m)
```

Column {data-width=490}
-----------------------------------------------------------------------

### Correlation Matrix

```{r}
DT::datatable (R, extensions = 'Buttons', options = list(pageLength = m, dom = 'Bt',buttons = c('copy'))) %>% formatRound(colnames(R), digits=2)
```

### p - value

```{r}
DT::datatable (P, extensions = 'Buttons', options = list(pageLength = m, dom = 'Bt',buttons = c('copy'))) %>% formatRound(colnames(P), digits=4) %>% formatStyle(varijable, color = styleInterval(c(0.05), c('red', 'black')))
```

Column {data-width=500}
-----------------------------------------------------------------------

### Scatter Plot

```{r}
shinyApp(

ui <- fluidPage(
        sidebarPanel(
          radioButtons("xcol", 
                       label = "Select Variable x:",
                       choices = colnames(my_data)),
            radioButtons("ycol", 
                       label = "Select Variable y:",
                       choices = colnames(my_data)),
        ),
        mainPanel(
           h4("Scatter Plot"),
          plotOutput("scatter"),
   )
),
server <- function(input, output, session) {

      selectedData <- reactive({
        my_data[, c(input$xcol, input$ycol)]
  })
      output$scatter <- renderPlot({
        xx    <- selectedData()
        ggplot(xx, aes(x=xx[,1], y=xx[,2])) +
        geom_point(size=2, colour = "#145DA0") +
        labs(x= input$xcol, y = input$ycol) +
        theme_minimal()
    })
},
shinyApp(ui = ui, server = server)
)
```

### Correlation Network

```{r}

shinyApp(
  
ui <- fluidPage(
            sidebarPanel(
              sliderInput("r",
                        "Correlation Coefficient Level:",
                        min = 0,
                        max = 1,
                        value = 0.35),
     ),
        mainPanel(
           h4("Correlation Network"),
           plotOutput("corPlot")
       ),
),
server <- function(input, output) {
    output$corPlot <- renderPlot({
    my_data %>% correlate() %>% network_plot(min_cor=input$r)
    })
},
shinyApp(ui = ui, server = server)
)

```

Eigenvalues
=======================================================================

Column {data-width=10}
-----------------------------------------------------------------------

### Cases

```{r}
valueBox(n)
```

### Variables

```{r}
valueBox(m)
```

### Data

```{r}
valueBox(n*m)
```

Column {data-width=490}
-----------------------------------------------------------------------

### Eigenvalues

```{r}
DT::datatable (Lamda, extensions = 'Buttons', options = list(pageLength = m, dom = 'Bt',buttons = c('copy')))  %>% formatRound(colnames(Lamda), digits=3)
```

### Communalities

```{r}
DT::datatable (Hgk, extensions = 'Buttons', options = list(pageLength = m, dom = 'Bt',buttons = c('copy')))
```

Column {data-width=500}
-----------------------------------------------------------------------

### Scree Plot - GK criterion

```{r}
spgk
```

### Scree Plot - PB criterion

```{r}
sppb
```

Varimax Rotation
=======================================================================

Column {data-width=10}
-----------------------------------------------------------------------

### Cases

```{r}
valueBox(n)
```

### Variables

```{r}
valueBox(m)
```

### Data

```{r}
valueBox(n*m)
```

Column {data-width=490}
-----------------------------------------------------------------------

### Factor Loadings

```{r}
DT::datatable (Fvf, extensions = 'Buttons', options = list(pageLength = m, dom = 'Bt',buttons = c('copy')))
```

Column {data-width=500}
-----------------------------------------------------------------------

### Graph Factor Loadings (variables)

```{r}
GFF11
```

### Graph Factor Loadings (Factors)

```{r}
GFF12
```


Oblimin Rotation
=======================================================================

Column {data-width=10}
-----------------------------------------------------------------------

### Cases

```{r}
valueBox(n)
```

### Variables

```{r}
valueBox(m)
```

### Data

```{r}
valueBox(n*m)
```

Column {data-width=490}
-----------------------------------------------------------------------

### Factor Loadings

```{r}
DT::datatable (Fof, extensions = 'Buttons', options = list(pageLength = m, dom = 'Bt',buttons = c('copy')))
```

### Factor Correlation

```{r}
DT::datatable (Rof, extensions = 'Buttons', options = list(pageLength = m, dom = 'Bt',buttons = c('copy')))
```

Column {data-width=500}
-----------------------------------------------------------------------

### Graph Factor Loadings (Variables)

```{r}
GFF21
```

### Graph Factor Loadings (Factors)

```{r}
GFF22
```
