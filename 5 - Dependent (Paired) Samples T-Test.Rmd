---
title: "Dependent (Paired) Samples T-Test"
output: 
  flexdashboard::flex_dashboard:
    theme: cerulean
runtime: shiny
---

```{r}
library(flexdashboard)
library(tidyverse)
library(DT)
library(psych)
library(car)
library(Rmisc)
library(gplots)
library(lsr)
library(ggthemes)
library(shinythemes)

setwd("~/R-aplikacije/Data")

data <- read.table(file.choose(),                  
                   header = TRUE,                      
                   dec = ",",                          
                   sep = ";",                          
                   stringsAsFactors = TRUE,
                   row.names = 1)

Factor <- data %>% select_if(is.factor)
Dependent <- data %>% select_if(is.numeric)

my_data <- cbind(Factor, Dependent)
vn <- variable.names(Dependent)
nn <- variable.names(Factor)
mm <- ncol(data)
m <- ncol(Dependent)
k <- ncol(Factor)
n <- nrow(data)
e <- n/2
```

Data
=======================================================================

Column {data-width=1000}
-----------------------------------------------------------------------

### Data

```{r}
DT::datatable(data, style = 'bootstrap', 
              filter = 'top', 
              extensions = 'Buttons', 
              options = list(pageLength = n, dom = 'Brti', buttons = c('copy','csv', 'excel')))
```

T-Test
=======================================================================

Column {data-width=1000}
-----------------------------------------------------------------------

### T-Test

```{r}

shinyApp(

ui <- fluidPage(theme = shinytheme("cerulean"),
        sidebarPanel(
          radioButtons("radio1", 
                       label = "Dependent Variables:",
                       choices = colnames(my_data[k+1:m])),
           radioButtons("radio2", 
                       label = "Inependent Variables:",
                       choices = colnames(my_data[1:k])),
           sliderInput("bins",
                        "Broj razreda:",
                        min = 1,
                        max = 100,
                        value = 7)
          
        ),
        mainPanel(
          tabsetPanel(
             tabPanel("Descirptive Parameters & Normality Test", br(),
                  h5("Descirptive Parameters"),
                  dataTableOutput ("des"),
                  hr(),
                  h5("Normality Test (Shapiro-Wilk)"),
                  textOutput ("shapiro"),
                  hr(),
                  h5("Histogram"),
                  plotOutput("histogram"),
                  hr(),
                  h5("Box and Whiskers plot"),
                  plotOutput("box")
                  ),
              tabPanel("T-test", br(),
                 htmlOutput("t"),
                 hr(),
                 h5 ("Mean Plot with 95% Confidence Interval"),
                 plotOutput("err")
                 )
            )
        )
),
server <- function(input, output, session) {

      selectedData1 <- reactive({
        my_data[, input$radio1]
  })
      selectedData2 <- reactive({   
        my_data[, input$radio2]
  })
 
      output$shapiro <- renderText({
        Variables1 <- selectedData1()[1:e]
        Variables2 <- selectedData1()[(e+1):n]
        dif <- Variables1 - Variables2
        sw <- shapiro.test(dif)
        W <- round(sw$statistic, digits = 3)
        p <- round(sw$p.value, digits = 3)
        paste("W = ", W,", p = ", p)
       })
      
       output$des <- renderDataTable({
        Variables <- selectedData1
        Factor    <- selectedData2()
        des = summarySE(my_data, measurevar= input$radio1, groupvars=c(input$radio2))
        CI1 <- des[3] - des$ci
        CI2 <- des[3] + des$ci
        des <- cbind(des, CI1, CI2)
        des <- des[c(1, 2, 3, 4, 5, 7, 8)]
        colnames(des) <- c(input$radio2, "N", "MEAN", "SD", "SEM", "-CI95%", "+CI95%")
        des%>% DT::datatable (rownames = FALSE, style = 'bootstrap', extensions = 'Buttons', options = list(pageLength = 100, dom = 'Bt',buttons = c('copy'))) %>% formatRound(c("MEAN", "SD", "SEM", "-CI95%", "+CI95%"), 3)
       })
       
      output$histogram <- renderPlot({
        Variables    <- selectedData1()
        Factor    <- selectedData2()
        ggplot(my_data, aes(x=Variables)) + 
        geom_histogram(bins=input$bins, color="#000000", fill="#4477AA") +
        labs(x= input$radio, y = "Frequency") +
        facet_wrap(Factor)+
        theme_minimal()
  })
       
      output$box <- renderPlot({
        Variables  <- selectedData1()
        Groups     <- selectedData2()
        ggplot(my_data, aes(x=Groups, y=Variables, fill=Groups)) + 
        geom_boxplot(color="#000000", outlier.colour="#D1495B", outlier.size=3) +
        stat_summary(fun=mean, geom="point", shape=16, size=2, color="#000000") +
        labs(x = input$radio2, y = input$radio1, fill = input$radio2) +
        theme_minimal() + scale_fill_ptol()
  })
      
       output$t <- renderText({
        Variables <- selectedData1()
        Factor    <- selectedData2()
        tt <- t.test(Variables ~ Factor, data = my_data,  paired = TRUE, var.equal = TRUE)
        md <-  round(tt$estimate[[1]], digits = 3)
        se <- round(tt$stderr[1], digits = 3)
        r <- round(cor(Variables[1:e],Variables[e+1:e]), digits = 3)
        ttt <- round(tt$statistic[1], digits = 3)
        dft <- round(tt$parameter[1], digits = 3)
        ptt <- round(tt$p.value[1], digits = 3)
        d <- round(cohensD(Variables~Factor, method = "paired"), digits = 3)
        paste(
          "Mean difference =", md , "</br>", 
          "St. error difference =", se , "</br>", 
          "Correlations =", r, "</br>", 
          "Student's t = ", ttt , "</br>", 
          "df =", dft, "</br>",
          "p = ", ptt, "</br>",
          "Cohen's d =", d)
    })  
      
      output$err <- renderPlot({
        Variables <- selectedData1()
        Factor <-  selectedData2()
        plotmeans(Variables~Factor, 
                  data=my_data, 
                  col = "#D1495B",
                  barcol ="#4477AA", 
                  barwidth = 3,
                  connect = TRUE, 
                  n.label = FALSE, 
                  xlab = input$radio2, 
                  ylab = input$radio1
                  )
    })
  
},
shinyApp(ui = ui, server = server)
)
```
